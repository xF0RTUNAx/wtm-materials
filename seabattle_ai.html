<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>xFORTUNAx | –ú–æ—Ä—Å–∫–æ–π –±–æ–π</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-color: #0f0f12; --grid-color: #1a1a20; --border-color: #2c2c35; --highlight: #00e5ff;
            --hit: #ff4757; --miss: #dfe4ea; --radar: #9b59b6; --barrage: #ff9f43; --detected: #f1c40f;
            --msg-success-bg: #d1e7dd; --msg-success-text: #0f5132;
            --msg-error-bg: #f8d7da; --msg-error-text: #842029;
            --progress-bg: #2c3e50; --progress-fill: #27ae60;
            --warning-border: #ff4757; --warning-bg: rgba(255, 71, 87, 0.1);
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            /* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –≤—ã—Å–æ—Ç—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ */
            min-height: 100dvh; 
            margin: 0;
            padding: 10px;
            overflow-x: hidden;
        }

        /* –ù–ê–í–ò–ì–ê–¶–ò–Ø */
        .top-nav { width: 100%; max-width: 800px; display: flex; justify-content: flex-start; margin-bottom: 5px; }
        .btn-back-home {
            background: rgba(255, 255, 255, 0.1); color: #ccc; text-decoration: none;
            padding: 6px 12px; border-radius: 8px; font-size: 0.85rem; display: flex; align-items: center;
            gap: 8px; transition: 0.3s; border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-back-home:hover { background: rgba(255, 255, 255, 0.2); color: white; }

        h1 { margin: 5px 0; text-align: center; text-transform: uppercase; letter-spacing: 1px; font-size: 1.3rem; text-shadow: 0 0 15px rgba(0, 229, 255, 0.3); }
        
        .info-panel {
            background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 10px;
            width: 100%; max-width: 600px; text-align: left; margin-bottom: 10px;
            font-size: 0.75rem; line-height: 1.3; color: #ccc; border-left: 3px solid var(--highlight);
        }
        .info-panel strong { color: var(--highlight); }

        /* –ë–õ–û–ö –°–û–•–†–ê–ù–ï–ù–ò–Ø –ü–†–û–ì–†–ï–°–°–ê */
        .save-warning-box {
            margin-top: 8px;
            background-color: var(--warning-bg);
            border: 1px solid var(--warning-border);
            border-radius: 6px;
            padding: 8px;
            color: #eee;
            font-size: 0.7rem;
        }
        .save-header {
            color: var(--warning-border); font-weight: 700; font-size: 0.8rem;
            margin-bottom: 4px; display: flex; align-items: center; gap: 6px; text-transform: uppercase;
        }
        .warning-row { display: flex; gap: 6px; margin-top: 4px; align-items: flex-start; color: #ffcccc; }
        .warning-icon { color: #f1c40f; font-size: 0.9rem; margin-top: 1px; }

        /* –ü–†–û–ì–†–ï–°–° –ë–ê–† */
        .progress-section {
            width: 100%; max-width: 500px; margin-bottom: 15px;
            background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; border: 1px solid var(--border-color);
        }
        .progress-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.8rem; color: #ddd; }
        .win-counter { color: var(--highlight); font-weight: bold; }
        .progress-track { width: 100%; height: 8px; background: var(--progress-bg); border-radius: 4px; overflow: hidden; position: relative; margin-bottom: 10px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #2ecc71, #00b894); width: 0%; transition: width 0.5s ease-out; }
        .milestones { display: flex; justify-content: space-between; align-items: flex-start; position: relative; }
        .milestone-item { display: flex; flex-direction: column; align-items: center; gap: 2px; width: 18%; position: relative; cursor: pointer; }
        .milestone-img {
            width: 100%; max-width: 35px; height: 35px; object-fit: contain;
            filter: grayscale(1) opacity(0.4); transition: 0.3s;
            border: 2px solid transparent; border-radius: 6px; padding: 1px;
        }
        .milestone-item.unlocked .milestone-img { filter: none; border-color: var(--detected); box-shadow: 0 0 10px rgba(241, 196, 15, 0.3); }
        .milestone-label { font-size: 0.6rem; text-align: center; color: #777; }
        .milestone-item.unlocked .milestone-label { color: #fff; font-weight: bold; }

        /* –ò–ì–†–û–í–û–ï –ü–û–õ–ï - –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
        .status-bar { font-size: 1rem; font-weight: bold; color: var(--highlight); margin-bottom: 5px; height: 20px; text-align: center; }
        .game-wrapper { display: flex; flex-direction: column; align-items: center; gap: 15px; width: 100%; }
        .boards-container { display: flex; flex-direction: row; gap: 20px; flex-wrap: wrap; justify-content: center; width: 100%; }
        .grid-section { display: flex; flex-direction: column; align-items: center; }
        .grid-title { margin-bottom: 5px; font-weight: 600; color: #aaa; font-size: 0.8rem; }
        
        /* –ì–õ–ê–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –°–ï–¢–ö–ê */
        .grid {
            display: grid;
            /* 10 –∫–æ–ª–æ–Ω–æ–∫ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π —à–∏—Ä–∏–Ω—ã */
            grid-template-columns: repeat(10, 1fr);
            grid-template-rows: repeat(10, 1fr);
            gap: 1px; 
            background-color: var(--border-color);
            border: 2px solid var(--border-color);
            border-radius: 4px;
            position: relative;
            
            /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã */
            width: 100%;
            /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞: –ª–∏–±–æ 450px, –ª–∏–±–æ 92% —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞, –≤—ã–±–∏—Ä–∞–µ–º –º–µ–Ω—å—à–µ–µ */
            width: min(92vw, 450px);
            /* –î–µ–ª–∞–µ–º –≤—ã—Å–æ—Ç—É —Ä–∞–≤–Ω–æ–π —à–∏—Ä–∏–Ω–µ (–∫–≤–∞–¥—Ä–∞—Ç) */
            aspect-ratio: 1 / 1;
            
            /* –í–∞–∂–Ω–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö: —É–±–∏—Ä–∞–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É –ø—Ä–∏ –¥—Ä–∞–≥–µ */
            touch-action: none;
        }

        .cell {
            width: 100%;
            height: 100%;
            background-color: var(--grid-color);
            cursor: crosshair;
            position: relative;
            transition: background 0.1s;
        }
        
        .grid.special-mode .cell { cursor: cell; } 
        
        /* –°—Ç–∏–ª–∏ —Ö–æ–≤–µ—Ä–æ–≤ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π */
        @media (hover: hover) {
            .cell:hover::before {
                content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(255,255,255,0.1); pointer-events: none; z-index: 1;
            }
        }
        
        .cell.hover-valid { background-color: rgba(0, 229, 255, 0.3); } 
        .cell.hover-invalid { background-color: rgba(255, 68, 68, 0.3); }
        .cell.radar-preview { background-color: rgba(155, 89, 182, 0.5) !important; box-shadow: 0 0 5px var(--radar); z-index: 5; }
        .cell.barrage-preview { background-color: rgba(255, 159, 67, 0.5) !important; box-shadow: 0 0 5px var(--barrage); z-index: 5; }

        .player-cell.occupied { border: 1px solid rgba(0,0,0,0.5); }
        .player-cell.occupied.lun { background-color: #fab1a0; } .player-cell.occupied.battleship { background-color: #b2bec3; } .player-cell.occupied.missile { background-color: #55efc4; }
        /* –®—Ä–∏—Ñ—Ç –≤–Ω—É—Ç—Ä–∏ –∫–ª–µ—Ç–∫–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —ç–∫—Ä–∞–Ω–∞ */
        .ship-grid-label { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: 800; font-size: clamp(10px, 4vw, 16px); 
            color: #fff; text-shadow: 0 0 2px #000; z-index: 2; pointer-events: none; 
        }

        .cell::after { z-index: 5; pointer-events: none; }
        .cell.miss::after {
            content: ''; position: absolute; top: 50%; left: 50%; width: 25%; height: 25%;
            background-color: var(--miss); border-radius: 50%; transform: translate(-50%, -50%);
        }
        
        .cell.hit { background-color: rgba(255, 71, 87, 0.2); }
        .cell.hit::after { content: '‚úï'; font-size: clamp(14px, 5vw, 24px); color: var(--hit); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); line-height: 0; font-weight: bold; }
        
        .player-cell.occupied.hit { background-color: #2d0000 !important; border-color: #ff0000 !important; }
        .player-cell.occupied.hit::after { content: 'üî•'; font-size: clamp(16px, 6vw, 28px); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); line-height: 0; z-index: 5; filter: drop-shadow(0 0 5px orange); animation: burn 1s infinite alternate; }
        
        .cell.sunk { background-color: #2f3542 !important; border: 2px solid #ff4757 !important; opacity: 0.8; }
        .cell.sunk::after { content: 'üíÄ'; font-size: clamp(14px, 5vw, 24px); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); line-height: 0; z-index: 6; animation: none; }
        @keyframes burn { from { transform: translate(-50%, -50%) scale(1); } to { transform: translate(-50%, -50%) scale(1.2); } }
        
        .cell.detected { background-color: rgba(241, 196, 15, 0.2); border: 1px solid var(--detected); }
        .cell.detected::after { content: 'üëÅÔ∏è'; font-size: clamp(12px, 4vw, 20px); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); line-height: 0; }

        /* –î–û–ö –ö–û–†–ê–ë–õ–ï–ô */
        .dock { 
            background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; 
            width: min(95vw, 500px); 
            display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; 
            border: 1px solid rgba(255,255,255,0.1); 
        }
        .ship-container { 
            display: flex; flex-direction: column; align-items: center; gap: 2px; 
            padding: 4px 8px; background: rgba(0,0,0,0.3); border-radius: 6px; 
            cursor: grab; border: 2px solid transparent; transition: all 0.3s; position: relative; 
            width: 22%; min-width: 60px; /* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –≤ –¥–æ–∫–µ */
        }
        .ship-container:active { cursor: grabbing; } .ship-container.placed { opacity: 0.5; filter: grayscale(1); cursor: default; } .ship-container.selected { border-color: var(--highlight); background: rgba(0, 229, 255, 0.1); }
        .ship-visual { display: flex; align-items: center; justify-content: center; padding: 2px; width: 100%; height: 30px; } 
        .ship-img { width: auto; height: 100%; max-width: 100%; object-fit: contain; filter: drop-shadow(2px 4px 4px rgba(0,0,0,0.8)); }
        .ship-info { display: flex; flex-direction: column; justify-content: center; text-align: center; } 
        .ship-name { font-weight: 700; font-size: 0.7rem; color: #eee; line-height: 1.1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; } 
        .ship-size { font-size: 0.6rem; color: #aaa; }

        /* –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø */
        .controls { display: flex; gap: 8px; justify-content: center; margin-top: 5px; flex-wrap: wrap; width: 100%; max-width: 500px; }
        .btn { padding: 8px 16px; background: var(--highlight); color: #0f0f12; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; transition: 0.3s; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px; flex: 1; min-width: 80px; text-align: center; }
        .btn:hover { box-shadow: 0 0 10px var(--highlight); transform: translateY(-1px); } .btn:disabled { background: #555; color: #888; cursor: not-allowed; box-shadow: none; transform: none; }
        .btn-start { background: linear-gradient(45deg, #2ed573, #26de81); color: white; display: none; }
        .btn-radar { background: linear-gradient(45deg, #8e44ad, #9b59b6); color: white; } .btn-radar.active { box-shadow: 0 0 15px #9b59b6; border: 2px solid white; }
        .btn-barrage { background: linear-gradient(45deg, #ff9f43, #ee5253); color: white; } .btn-barrage.active { box-shadow: 0 0 15px #ee5253; border: 2px solid white; }
        #enemy-area { display: none; }

        /* –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 5000; display: none; align-items: center; justify-content: center; padding: 15px; }
        .result-card { width: 100%; max-width: 400px; border-radius: 12px; padding: 20px; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: slideIn 0.4s ease-out; }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .result-card.win { background-color: var(--msg-success-bg); border-left: 6px solid var(--msg-success-text); color: var(--msg-success-text); }
        .result-card.lose { background-color: var(--msg-error-bg); border-left: 6px solid var(--msg-error-text); color: var(--msg-error-text); }
        .result-header { font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .result-body { font-size: 0.9rem; line-height: 1.4; }
        .result-actions { display: flex; justify-content: flex-end; margin-top: 5px; }
        .btn-restart { padding: 8px 16px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; background: rgba(0,0,0,0.1); color: inherit; transition: 0.2s; } .btn-restart:hover { background: rgba(0,0,0,0.2); }
        .reward-img { width: 100%; max-width: 180px; border-radius: 8px; margin: 10px auto; display: block; border: 2px solid #0f5132; }
        
        .verification-code { background: #fff; color: #333; padding: 6px; border-radius: 6px; font-family: monospace; font-size: 0.8rem; text-align: center; border: 2px dashed #999; margin-top: 8px; word-break: break-all; }
        .btn-support { display: inline-block; width: 100%; margin-top: 8px; padding: 8px; background: #0088cc; color: white; text-decoration: none; border-radius: 50px; font-weight: bold; font-size: 0.8rem; text-align: center; transition: 0.3s; }
        .btn-support:hover { background: #0077b5; box-shadow: 0 0 10px #0088cc; }
        .screenshot-warning { font-size: 0.7rem; color: #ff9f43; margin-top: 5px; font-style: italic; font-weight: 600; text-align: center; }

        /* –õ–∞–Ω–¥—à–∞—Ñ—Ç–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è (–º–æ–±–∏–ª—å–Ω—ã–π –ø–æ–≤–µ—Ä–Ω—É—Ç) */
        @media (max-height: 500px) and (orientation: landscape) {
            body { padding: 5px; flex-direction: row; flex-wrap: wrap; justify-content: center; align-items: flex-start; }
            h1, .top-nav, .info-panel, .progress-section { display: none; }
            .game-wrapper { margin-top: 0; width: auto; flex-direction: row; align-items: flex-start; }
            .boards-container { gap: 10px; width: auto; }
            .grid { width: 75vh; } /* –í—ã—Å–æ—Ç–∞ —ç–∫—Ä–∞–Ω–∞ –¥–∏–∫—Ç—É–µ—Ç —Ä–∞–∑–º–µ—Ä */
            .dock { width: 120px; height: 80vh; overflow-y: auto; flex-direction: column; justify-content: flex-start; }
            .ship-container { width: 100%; }
            .controls { flex-direction: column; width: 120px; }
        }
    </style>
</head>
<body>
    <nav class="top-nav">
        <a href="findagame.html" class="btn-back-home"><i class="fas fa-arrow-left"></i> –í—ã—Ö–æ–¥</a>
    </nav>

    <h1>–ú–æ—Ä—Å–∫–æ–π –±–æ–π</h1>
    
    <div class="info-panel">
        <div style="text-align:center; margin-bottom:10px;"><strong>–ü—Ä–∞–≤–∏–ª–∞</strong></div>
        1. –†–∞—Å—Å—Ç–∞–≤—å—Ç–µ —Ñ–ª–æ—Ç. <br>2. –ñ–º–∏—Ç–µ "–í –±–æ–π".<br>
        <strong>–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (1 —Ä–∞–∑ –∑–∞ –±–æ–π):</strong><br>
        ‚Ä¢ <i class="fas fa-satellite-dish" style="color:var(--radar)"></i> <strong>–†–∞–¥–∞—Ä (–õ—É–Ω—å):</strong> –†–∞–∑–≤–µ–¥–∫–∞ 2x2. (–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ –ø—Ä–∏ –≥–∏–±–µ–ª–∏ –õ—É–Ω—è)<br>
        ‚Ä¢ <i class="fas fa-bomb" style="color:var(--barrage)"></i> <strong>–ó–∞–ª–ø (–õ–∏–Ω–∫–æ—Ä):</strong> –£–¥–∞—Ä 2x2. (–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ –ø—Ä–∏ –≥–∏–±–µ–ª–∏ –õ–∏–Ω–∫–æ—Ä–∞)<br>
        
        <div class="save-warning-box">
            <div class="save-header"><i class="fas fa-save"></i> –°–û–•–†–ê–ù–ï–ù–ò–ï –ü–†–û–ì–†–ï–°–°–ê</div>
            <div class="save-text">
                –ß—Ç–æ–±—ã –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å –ø–æ–±–µ–¥—ã –¥–ª—è –Ω–∞–≥—Ä–∞–¥, –≤—Å–µ–≥–¥–∞ –∏–≥—Ä–∞–π—Ç–µ —á–µ—Ä–µ–∑ <strong>–æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –±—Ä–∞—É–∑–µ—Ä –∏–ª–∏ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</strong>.
            </div>
            <div class="warning-row">
                <i class="fas fa-exclamation-triangle warning-icon"></i>
                <span>–†–µ–∂–∏–º –ò–Ω–∫–æ–≥–Ω–∏—Ç–æ –∏ –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ <strong style="color:#ff6b6b">—É–¥–∞–ª—è—Ç</strong> –≤–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞–≤—Å–µ–≥–¥–∞.</span>
            </div>
        </div>
    </div>

    <div class="progress-section">
        <div class="progress-header"><span>–ü—Ä–æ–≥—Ä–µ—Å—Å</span><span class="win-counter">–ü–æ–±–µ–¥—ã: <span id="total-wins">0</span></span></div>
        <div class="progress-track"><div class="progress-fill" id="progress-fill"></div></div>
        <div class="milestones">
            <div class="milestone-item" id="ms-10" data-title="10 –ü–æ–±–µ–¥"><img src="https://cdn.jsdelivr.net/gh/xF0RTUNAx/wtm-materials@pics/starttitle.jpg" class="milestone-img"><span class="milestone-label">10</span></div>
            <div class="milestone-item" id="ms-50" data-title="50 –ü–æ–±–µ–¥"><img src="https://cdn.jsdelivr.net/gh/xF0RTUNAx/wtm-materials@pics/exptitle.jpg" class="milestone-img"><span class="milestone-label">50</span></div>
            <div class="milestone-item" id="ms-100" data-title="100 –ü–æ–±–µ–¥"><img src="https://cdn.jsdelivr.net/gh/xF0RTUNAx/wtm-materials@pics/gold.PNG" class="milestone-img"><span class="milestone-label">100</span></div>
            <div class="milestone-item" id="ms-250" data-title="250 –ü–æ–±–µ–¥"><img src="https://cdn.jsdelivr.net/gh/xF0RTUNAx/wtm-materials@pics/7day.PNG" class="milestone-img"><span class="milestone-label">250</span></div>
            <div class="milestone-item" id="ms-500" data-title="500 –ü–æ–±–µ–¥"><img src="https://cdn.jsdelivr.net/gh/xF0RTUNAx/wtm-materials@pics/platina.PNG" class="milestone-img"><span class="milestone-label">500</span></div>
        </div>
    </div>

    <div class="status-bar" id="status-bar">–†–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–æ—Ç–∞</div>

    <div class="game-wrapper">
        <div class="boards-container">
            <div class="grid-section"><div class="grid-title">–í–ê–® –§–õ–û–¢</div><div class="grid" id="player-grid"></div></div>
            <div class="grid-section" id="enemy-area"><div class="grid-title">–†–ê–î–ê–† –¶–ï–õ–ò</div><div class="grid" id="enemy-grid"></div></div>
        </div>
        <div class="controls" id="setup-controls">
            <button class="btn" onclick="rotateAxis()">–ü–æ–≤–æ—Ä–æ—Ç: <span id="axis-display">–ì–æ—Ä–∏–∑–æ–Ω—Ç.</span></button>
            <button class="btn btn-start" id="btn-start-game" onclick="startGame()">–í –ë–û–ô</button>
            <button class="btn" style="background:#ff4444; color:white" onclick="location.reload()">–°–±—Ä–æ—Å</button>
        </div>
        <div class="controls" id="battle-controls" style="display: none;">
            <button class="btn btn-radar" id="btn-radar" onclick="toggleRadar()"><i class="fas fa-satellite-dish"></i> –†–∞–¥–∞—Ä</button>
            <button class="btn btn-barrage" id="btn-barrage" onclick="toggleBarrage()"><i class="fas fa-bomb"></i> –ó–∞–ª–ø</button>
            <button class="btn" style="background:#ff4444; color:white" onclick="location.reload()">–°–¥–∞—Ç—å—Å—è</button>
        </div>
        <div class="dock" id="dock">
            <div class="ship-container ship-lun" id="p-lun" draggable="true" data-size="1" data-type="lun"><div class="ship-visual"><img src="https://cdn.jsdelivr.net/gh/xF0RTUNAx/wtm-materials@pics/lun.PNG" class="ship-img" alt="Lun"></div><div class="ship-info"><span class="ship-name">–õ—É–Ω—å</span><span class="ship-size">1 –∫–ª.</span></div></div>
            <div class="ship-container ship-battleship" id="p-bs" draggable="true" data-size="4" data-type="battleship"><div class="ship-visual"><img src="https://cdn.jsdelivr.net/gh/xF0RTUNAx/wtm-materials@pics/USS%20Tennessee.PNG" class="ship-img" alt="USS Tennessee"></div><div class="ship-info"><span class="ship-name">Tennessee</span><span class="ship-size">4 –∫–ª.</span></div></div>
            <div class="ship-container ship-missile" id="p-ms1" draggable="true" data-size="2" data-type="missile"><div class="ship-visual"><img src="https://cdn.jsdelivr.net/gh/xF0RTUNAx/wtm-materials@pics/Pr.%2011352.PNG" class="ship-img" alt="Pr. 11352"></div><div class="ship-info"><span class="ship-name">–ü—Ä. 11352</span><span class="ship-size">2 –∫–ª.</span></div></div>
            <div class="ship-container ship-missile" id="p-ms2" draggable="true" data-size="3" data-type="missile"><div class="ship-visual"><img src="https://cdn.jsdelivr.net/gh/xF0RTUNAx/wtm-materials@pics/HMS%20Type%2045.PNG" class="ship-img" alt="HMS Type 45"></div><div class="ship-info"><span class="ship-name">Type 45</span><span class="ship-size">3 –∫–ª.</span></div></div>
        </div>
    </div>

    <div class="overlay" id="result-overlay"><div class="result-card" id="result-card-content"></div></div>

    <script>
    // --- –ó–ê–©–ò–¢–ê –î–û–°–¢–£–ü–ê ---
    (function checkSessionGuard() {
        const sessionRaw = localStorage.getItem('wtm_session');
        if (!sessionRaw) {
            window.location.href = 'minigame.html';
            return;
        }
        let session;
        try { session = JSON.parse(sessionRaw); } catch (e) {
            localStorage.removeItem('wtm_session');
            window.location.href = 'minigame.html';
            return;
        }
        if (session.type === 'temporary') {
            const checkTime = () => {
                const now = Date.now();
                const timeLeft = session.expiry - now;
                if (timeLeft <= 0) {
                    alert("‚è≥ –í—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–∏—è —Ä–µ–∫–ª–∞–º–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∏—Å—Ç–µ–∫–ª–æ.");
                    localStorage.removeItem('wtm_session');
                    window.location.href = 'minigame.html';
                }
            };
            checkTime();
            setInterval(checkTime, 60000); 
        }
    })();
    // --- –ö–û–ù–ï–¶ –ó–ê–©–ò–¢–´ ---
        
        const gridSize = 10;
        let isHorizontal = true;
        let gameState = 0; 
        
        let playerBoard = Array(100).fill(null);
        let enemyBoard = Array(100).fill(null);
        let enemyBoardVis = Array(100).fill(null);

        const pGrid = document.getElementById('player-grid');
        const eGrid = document.getElementById('enemy-grid');
        const statusEl = document.getElementById('status-bar');
        const btnStart = document.getElementById('btn-start-game');
        
        const btnRadar = document.getElementById('btn-radar');
        const btnBarrage = document.getElementById('btn-barrage');
        
        let draggedShip = null; let selectedShip = null;
        let placedShipsCount = 0; const totalShips = 4;

        const fleet = { 'p-lun': { size: 1, type: 'lun', hits: 0, cells: [] }, 'p-bs':  { size: 4, type: 'battleship', hits: 0, cells: [] }, 'p-ms1': { size: 2, type: 'missile', hits: 0, cells: [] }, 'p-ms2': { size: 3, type: 'missile', hits: 0, cells: [] } };
        let enemyFleet = []; let aiStack = []; 
        let radarUsed = false; let isRadarMode = false;
        let barrageUsed = false; let isBarrageMode = false;

        
        const SALT = "wtm_secret_salt_2025_fortuna"; 

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = (hash << 5) - hash + char;
                hash = hash & hash; 
            }
            return Math.abs(hash).toString(16);
        }

        const SecureStorage = {
            saveWins: function(wins) {
                const hash = simpleHash(wins + SALT);
                localStorage.setItem('wtm_wins', wins);
                localStorage.setItem('wtm_hash', hash);
            },
            getWins: function() {
                const wins = localStorage.getItem('wtm_wins');
                const hash = localStorage.getItem('wtm_hash');
                if (!wins || !hash) return 0;
                if (simpleHash(wins + SALT) !== hash) {
                    alert("–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è! –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±—Ä–æ—à–µ–Ω.");
                    this.reset();
                    return 0;
                }
                return parseInt(wins);
            },
            reset: function() {
                localStorage.removeItem('wtm_wins');
                localStorage.removeItem('wtm_hash');
            }
        };

        
        function generateVerificationCode(wins) {
            const date = new Date();
            const timeKey = `${date.getUTCDate()}${date.getUTCMonth()}${date.getUTCFullYear()}`;
            const rawSignature = `${wins}-${timeKey}-${SALT}`;
            const shortHash = simpleHash(rawSignature).substring(0, 6).toUpperCase();
            return `WTM-${wins}-${shortHash}`;
        }

        let totalWins = 0;
        const milestones = [10, 50, 100, 250, 500];

        function loadProgress() {
            totalWins = SecureStorage.getWins();
            updateProgressUI();
        }

        function updateProgressUI() {
            document.getElementById('total-wins').innerText = totalWins;
            let percent = (totalWins / 500) * 100;
            if (percent > 100) percent = 100;
            document.getElementById('progress-fill').style.width = percent + '%';
            milestones.forEach(ms => {
                const el = document.getElementById('ms-' + ms);
                if (totalWins >= ms) el.classList.add('unlocked');
                else el.classList.remove('unlocked');
            });
        }

        
        function initGrids() {
            loadProgress();
            createGrid(pGrid, 'player'); createGrid(eGrid, 'enemy');
            setupDragAndClick();
        }

        function createGrid(gridEl, owner) {
            gridEl.innerHTML = '';
            for (let i = 0; i < 100; i++) {
                const cell = document.createElement('div'); cell.classList.add('cell');
                cell.dataset.index = i;
                if (owner === 'player') {
                    cell.classList.add('player-cell');
                    cell.addEventListener('dragover', dragOver); cell.addEventListener('dragleave', dragLeave);
                    cell.addEventListener('drop', dropShip); cell.addEventListener('click', () => playerGridClick(i));
                    // Touch events for drag-drop
                    cell.addEventListener('touchstart', touchStartCell, {passive: false}); 
                    cell.addEventListener('touchmove', touchMoveCell, {passive: false});
                    cell.addEventListener('touchend', touchEndCell);
                } else {
                    cell.addEventListener('click', () => enemyGridClick(i));
                    cell.addEventListener('mouseenter', () => handleAbilityHover(i, true));
                    cell.addEventListener('mouseleave', () => handleAbilityHover(i, false));
                }
                gridEl.appendChild(cell);
            }
        }

        function setupDragAndClick() {
            document.querySelectorAll('.ship-container').forEach(ship => {
                ship.addEventListener('dragstart', (e) => { if (ship.classList.contains('placed')) { e.preventDefault(); return; } draggedShip = ship; });
                ship.addEventListener('click', (e) => { if (gameState === 0 && !ship.classList.contains('placed')) { if (selectedShip) selectedShip.classList.remove('selected'); ship.classList.add('selected'); selectedShip = ship; } });
                ship.addEventListener('touchstart', (e) => { if (ship.classList.contains('placed')) { e.preventDefault(); return; } draggedShip = ship; ship.style.opacity = '0.7'; }, {passive: false});
                ship.addEventListener('touchend', (e) => { ship.style.opacity = '1'; if (draggedShip) { if (gameState === 0 && !ship.classList.contains('placed')) { if (selectedShip) selectedShip.classList.remove('selected'); ship.classList.add('selected'); selectedShip = ship; } draggedShip = null; } });
            });
        }

        let lastTouchedCell = null;
        function touchStartCell(e) { 
            e.preventDefault(); // Prevent scrolling
            const touch = e.touches[0]; 
            const cell = document.elementFromPoint(touch.clientX, touch.clientY); 
            if (cell && cell.classList.contains('cell')) { 
                lastTouchedCell = cell; 
                const index = parseInt(cell.dataset.index); 
                if (selectedShip && gameState === 0) playerGridClick(index); 
                else if (draggedShip) highlight(index, parseInt(draggedShip.dataset.size), true); 
            } 
        }
        function touchMoveCell(e) { 
            e.preventDefault(); 
            const touch = e.touches[0]; 
            const cell = document.elementFromPoint(touch.clientX, touch.clientY); 
            if (cell && cell.classList.contains('cell') && cell !== lastTouchedCell) { 
                if (lastTouchedCell && draggedShip) highlight(parseInt(lastTouchedCell.dataset.index), parseInt(draggedShip.dataset.size), false); 
                lastTouchedCell = cell; 
                if (draggedShip) highlight(parseInt(cell.dataset.index), parseInt(draggedShip.dataset.size), true); 
            } 
        }
        function touchEndCell(e) { 
            e.preventDefault(); 
            if (lastTouchedCell && draggedShip) { 
                highlight(parseInt(lastTouchedCell.dataset.index), parseInt(draggedShip.dataset.size), false); 
                placeShipLogic(parseInt(lastTouchedCell.dataset.index), draggedShip); 
            } 
            draggedShip = null; lastTouchedCell = null; 
        }
        function dragOver(e) { e.preventDefault(); const ship = draggedShip || selectedShip; if (!ship) return; highlight(parseInt(this.dataset.index), parseInt(ship.dataset.size), true); }
        function dragLeave(e) { const ship = draggedShip || selectedShip; if (!ship) return; highlight(parseInt(this.dataset.index), parseInt(ship.dataset.size), false); }
        function dropShip(e) { e.preventDefault(); if (!draggedShip) return; placeShipLogic(parseInt(this.dataset.index), draggedShip); draggedShip = null; }
        function playerGridClick(index) { if (gameState === 0 && selectedShip) { if (placeShipLogic(index, selectedShip)) { selectedShip.classList.remove('selected'); selectedShip = null; } } }

        function placeShipLogic(index, shipEl) {
            const size = parseInt(shipEl.dataset.size); const id = shipEl.id; const type = shipEl.dataset.type; const indices = getIndices(index, size);
            if (!indices || !checkPlacementValidity(playerBoard, indices)) return false; 
            indices.forEach(idx => { playerBoard[idx] = id; pGrid.children[idx].classList.add('occupied', type); });
            const midIndex = Math.floor(indices.length / 2); const centerCell = pGrid.children[indices[midIndex]];
            if (id === 'p-ms1') centerCell.innerHTML += '<span class="ship-grid-label">1</span>'; if (id === 'p-ms2') centerCell.innerHTML += '<span class="ship-grid-label">2</span>'; 
            fleet[id].cells = indices;
            if (gameState === 0) { shipEl.classList.add('placed'); shipEl.draggable = false; placedShipsCount++; clearHighlights(); if (placedShipsCount === totalShips) { statusEl.innerText = "–§–ª–æ—Ç –≥–æ—Ç–æ–≤! –ù–∞–∂–º–∏—Ç–µ '–í –ë–û–ô'."; btnStart.style.display = 'inline-block'; } }
            return true; 
        }

        function checkPlacementValidity(board, indices) { for (let idx of indices) { if (board[idx] !== null) return false; const neighbors = getNeighbors(idx); for (let nIdx of neighbors) { if (board[nIdx] !== null) return false; } } return true; }
        function getNeighbors(idx) { const x = idx % 10; const y = Math.floor(idx / 10); let neighbors = []; for (let dy = -1; dy <= 1; dy++) { for (let dx = -1; dx <= 1; dx++) { if (dx === 0 && dy === 0) continue; const nx = x + dx; const ny = y + dy; if (nx >= 0 && nx < 10 && ny >= 0 && ny < 10) neighbors.push(ny * 10 + nx); } } return neighbors; }
        function getIndices(start, size) { let idxs = []; let x = start % 10; let y = Math.floor(start / 10); for (let i=0; i<size; i++) { if (isHorizontal) { if (x + i >= 10) return null; idxs.push(start + i); } else { if (y + i >= 10) return null; idxs.push(start + i * 10); } } return idxs; }
        function highlight(index, size, on) { const idxs = getIndices(index, size); if (!idxs) return; let valid = checkPlacementValidity(playerBoard, idxs); idxs.forEach(i => { const c = pGrid.children[i]; if (on) c.classList.add(valid ? 'hover-valid' : 'hover-invalid'); else c.classList.remove('hover-valid', 'hover-invalid'); }); }
        function clearHighlights() { Array.from(pGrid.children).forEach(c => c.classList.remove('hover-valid', 'hover-invalid')); }
        function rotateAxis() { isHorizontal = !isHorizontal; document.getElementById('axis-display').innerText = isHorizontal ? "–ì–æ—Ä–∏–∑–æ–Ω—Ç." : "–í–µ—Ä—Ç–∏–∫."; }

        function startGame() { setupAI(); document.getElementById('dock').style.display = 'none'; document.getElementById('setup-controls').style.display = 'none'; document.getElementById('battle-controls').style.display = 'flex'; document.getElementById('enemy-area').style.display = 'flex'; gameState = 2; statusEl.innerText = "–ë–û–ô! –í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å."; }
        function setupAI() { enemyFleet = []; const aiShipsSizes = [4, 3, 2, 1]; aiShipsSizes.forEach(size => { let placed = false; while (!placed) { let rnd = Math.floor(Math.random() * 100); let orient = Math.random() > 0.5; let idxs = []; let x = rnd % 10; let y = Math.floor(rnd / 10); let possible = true; for(let k=0; k<size; k++) { let ii = orient ? rnd + k : rnd + k*10; if ((orient && x+k>=10) || (!orient && y+k>=10)) { possible = false; break; } idxs.push(ii); } if (possible && checkPlacementValidity(enemyBoard, idxs)) { idxs.forEach(i => enemyBoard[i] = 'ship'); enemyFleet.push({ size: size, hits: 0, cells: idxs, sunk: false }); placed = true; } } }); }

        function getAbilityIndices(start) { const x = start % 10; const y = Math.floor(start / 10); if (x >= 9 || y >= 9) return null; return [start, start + 1, start + 10, start + 11]; }
        function handleAbilityHover(index, on) { if (!isRadarMode && !isBarrageMode) return; const idxs = getAbilityIndices(index); if (!idxs) return; if (isRadarMode) idxs.forEach(i => { const c = eGrid.children[i]; if(on) c.classList.add('radar-preview'); else c.classList.remove('radar-preview'); }); if (isBarrageMode) idxs.forEach(i => { const c = eGrid.children[i]; if(on) c.classList.add('barrage-preview'); else c.classList.remove('barrage-preview'); }); }
        function clearAbilityModes() { isRadarMode = false; isBarrageMode = false; btnRadar.classList.remove('active'); btnBarrage.classList.remove('active'); eGrid.classList.remove('special-mode'); Array.from(eGrid.children).forEach(c => c.classList.remove('radar-preview', 'barrage-preview')); }
        function toggleRadar() { if (gameState !== 2 || radarUsed || btnRadar.disabled) return; if (fleet['p-lun'].hits >= fleet['p-lun'].size) { alert("–õ—É–Ω—å —É–Ω–∏—á—Ç–æ–∂–µ–Ω! –†–∞–¥–∞—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."); btnRadar.disabled = true; return; } if (isRadarMode) { clearAbilityModes(); statusEl.innerText = "–†–∞–¥–∞—Ä –æ—Ç–º–µ–Ω–µ–Ω. –í–ê–® –•–û–î."; } else { clearAbilityModes(); isRadarMode = true; btnRadar.classList.add('active'); eGrid.classList.add('special-mode'); statusEl.innerText = "–†–ê–î–ê–†: –ó–æ–Ω–∞ 2x2."; } }
        function performRadarScan(index) { const idxs = getAbilityIndices(index); if (!idxs) return; radarUsed = true; btnRadar.innerText = "–†–∞–¥–∞—Ä (–ò—Å–ø.)"; btnRadar.disabled = true; clearAbilityModes(); let found = false; idxs.forEach(i => { const c = eGrid.children[i]; if (enemyBoardVis[i] === null) { if (enemyBoard[i] === 'ship') { enemyBoardVis[i] = 'detected'; c.classList.add('detected'); found = true; } else { enemyBoardVis[i] = 'miss'; c.classList.add('miss'); } } }); statusEl.innerText = found ? "–†–ê–î–ê–†: –¶–µ–ª—å –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞! –í–ê–® –•–û–î." : "–†–ê–î–ê–†: –ß–∏—Å—Ç–æ. –í–ê–® –•–û–î."; }
        function toggleBarrage() { if (gameState !== 2 || barrageUsed || btnBarrage.disabled) return; if (fleet['p-bs'].hits >= fleet['p-bs'].size) { alert("–õ–∏–Ω–∫–æ—Ä —É–Ω–∏—á—Ç–æ–∂–µ–Ω! –ó–∞–ª–ø –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."); btnBarrage.disabled = true; return; } if (isBarrageMode) { clearAbilityModes(); statusEl.innerText = "–ó–∞–ª–ø –æ—Ç–º–µ–Ω–µ–Ω. –í–ê–® –•–û–î."; } else { clearAbilityModes(); isBarrageMode = true; btnBarrage.classList.add('active'); eGrid.classList.add('special-mode'); statusEl.innerText = "–ó–ê–õ–ü –õ–ò–ù–ö–û–†–ê: –ó–æ–Ω–∞ 2x2."; } }
        function performBarrage(index) { const idxs = getAbilityIndices(index); if (!idxs) return; barrageUsed = true; btnBarrage.innerText = "–ó–∞–ª–ø (–ò—Å–ø.)"; btnBarrage.disabled = true; clearAbilityModes(); statusEl.innerText = "–û–ì–û–ù–¨! –ú–∞—Å—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É–¥–∞—Ä..."; let delay = 0; idxs.forEach(i => { setTimeout(() => { processShot(i); }, delay); delay += 200; }); setTimeout(() => { if (gameState === 2) { statusEl.innerText = "–ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞... –•–æ–¥ –ò–ò."; gameState = 3; setTimeout(aiTurn, 800); } }, delay + 500); }

        function enemyGridClick(index) { if (gameState !== 2) return; if (isRadarMode) { performRadarScan(index); return; } if (isBarrageMode) { performBarrage(index); return; } if (enemyBoardVis[index] !== null && enemyBoardVis[index] !== 'detected') return; processShot(index); if (enemyBoard[index] !== 'ship') { statusEl.innerText = "–ü–†–û–ú–ê–•. –•–æ–¥ –ò–ò..."; gameState = 3; setTimeout(aiTurn, 800); } }
        function processShot(index) { if (enemyBoardVis[index] !== null && enemyBoardVis[index] !== 'detected') return; const cell = eGrid.children[index]; if (enemyBoard[index] === 'ship') { enemyBoardVis[index] = 'hit'; cell.classList.remove('detected'); cell.classList.add('hit'); let shipDestroyed = checkEnemyShipDestruction(index); statusEl.innerText = shipDestroyed ? "–í–†–ê–ì –ü–û–¢–û–ü–õ–ï–ù! –í–∞—à —Ö–æ–¥." : "–ü–û–ü–ê–î–ê–ù–ò–ï! –í–∞—à —Ö–æ–¥."; checkWin('player'); } else { enemyBoardVis[index] = 'miss'; cell.classList.add('miss'); } }
        function checkEnemyShipDestruction(hitIndex) { let destroyed = false; enemyFleet.forEach(ship => { if (ship.sunk) return; if (ship.cells.includes(hitIndex)) { ship.hits++; if (ship.hits === ship.size) { ship.sunk = true; destroyed = true; ship.cells.forEach(i => eGrid.children[i].classList.add('sunk')); markNeighborsAsMiss(ship.cells, eGrid, enemyBoardVis); } } }); return destroyed; }
        function markNeighborsAsMiss(shipCells, gridEl, visArray) { shipCells.forEach(cellIdx => { getNeighbors(cellIdx).forEach(nIdx => { if (visArray[nIdx] === null) { visArray[nIdx] = 'miss'; gridEl.children[nIdx].classList.add('miss'); } }); }); }

        function aiTurn() { if (gameState !== 3) return; let index; if (aiStack.length === 0) { do { index = Math.floor(Math.random() * 100); } while (playerBoard[index] === 'miss' || playerBoard[index] === 'hit'); } else { index = aiStack.pop(); if (playerBoard[index] === 'miss' || playerBoard[index] === 'hit') { aiTurn(); return; } } const cell = pGrid.children[index]; const targetId = playerBoard[index]; if (targetId && targetId !== 'miss' && targetId !== 'hit') { playerBoard[index] = 'hit'; cell.classList.add('hit'); fleet[targetId].hits++; checkAbilitiesLoss(targetId); if (fleet[targetId].hits === fleet[targetId].size) { statusEl.innerText = "–ù–ê–® –ö–û–†–ê–ë–õ–¨ –£–ù–ò–ß–¢–û–ñ–ï–ù!"; fleet[targetId].cells.forEach(i => pGrid.children[i].classList.add('sunk')); markNeighborsAsMissPlayer(fleet[targetId].cells); aiStack = []; } else { statusEl.innerText = "–ü–û –ù–ê–° –ü–û–ü–ê–õ–ò! –ò–ò –¥–æ–±–∏–≤–∞–µ—Ç."; addNeighborsToStack(index); } checkWin('ai'); setTimeout(aiTurn, 1000); } else { playerBoard[index] = 'miss'; cell.classList.add('miss'); statusEl.innerText = "–ò–ò –ø—Ä–æ–º–∞—Ö–Ω—É–ª—Å—è. –í–ê–® –•–û–î."; gameState = 2; } }
        function checkAbilitiesLoss(shipId) { if (shipId === 'p-lun' && fleet['p-lun'].hits === fleet['p-lun'].size) { if (!radarUsed) { btnRadar.disabled = true; alert("–õ—É–Ω—å —É–Ω–∏—á—Ç–æ–∂–µ–Ω! –°–≤—è–∑—å —Å —Ä–∞–¥–∞—Ä–æ–º –ø–æ—Ç–µ—Ä—è–Ω–∞."); } } if (shipId === 'p-bs' && fleet['p-bs'].hits === fleet['p-bs'].size) { if (!barrageUsed) { btnBarrage.disabled = true; alert("–õ–∏–Ω–∫–æ—Ä —É–Ω–∏—á—Ç–æ–∂–µ–Ω! –û—Ä—É–¥–∏—è –º–æ–ª—á–∞—Ç."); } } }
        function markNeighborsAsMissPlayer(shipCells) { shipCells.forEach(cellIdx => { getNeighbors(cellIdx).forEach(nIdx => { if (playerBoard[nIdx] !== 'hit' && playerBoard[nIdx] !== 'miss') { playerBoard[nIdx] = 'miss'; pGrid.children[nIdx].classList.add('miss'); } }); }); }
        function addNeighborsToStack(idx) { const x = idx % 10; const y = Math.floor(idx / 10); const candidates = []; if (y > 0) candidates.push(idx - 10); if (y < 9) candidates.push(idx + 10); if (x > 0) candidates.push(idx - 1);  if (x < 9) candidates.push(idx + 1); candidates.sort(() => Math.random() - 0.5); candidates.forEach(c => { if (playerBoard[c] !== 'miss' && playerBoard[c] !== 'hit') aiStack.push(c); }); }
        function checkWin(who) { if (who === 'player') { if (enemyFleet.every(s => s.sunk)) showResultModal(true); } else { if (Object.values(fleet).every(s => s.hits === s.size)) showResultModal(false); } }

        function showResultModal(isWin) {
            const overlay = document.getElementById('result-overlay');
            const content = document.getElementById('result-card-content');
            overlay.style.display = 'flex';

            if (isWin) {
                totalWins++;
                
                SecureStorage.saveWins(totalWins);
                updateProgressUI();

                
                const verifyCode = generateVerificationCode(totalWins);
                const reward = determineReward();

                content.className = 'result-card win';
                content.innerHTML = `
                    <div class="result-header"><i class="fas fa-check-circle"></i> Win - –ü–æ–±–µ–¥–∞!</div>
                    <div class="result-body">
                        –í—Ä–∞–≥ —Ä–∞–∑–±–∏—Ç! <strong>–ü–æ–±–µ–¥: ${totalWins}</strong><br>
                        ${reward}
                        <div class="verification-code">
                             <strong>${verifyCode}</strong>
                        </div>
                        <div class="screenshot-warning">–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–≥—Ä–∞–¥—ã –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–æ–ª–Ω—ã–π —Å–∫—Ä–∏–Ω—à–æ—Ç –≤ —Ç–µ—Ö –ø–æ–¥–¥–µ—Ä–∂–∫—É</div>
                        <a href="https://t.me/fortunawtmhelp" target="_blank" class="btn-support">
                            <i class="fab fa-telegram"></i> –¢–µ—Ö. –ø–æ–¥–¥–µ—Ä–∂–∫–∞
                        </a>
                    </div>
                    <div class="result-actions"><button class="btn-restart" onclick="location.reload()">–î–∞–ª—å—à–µ</button></div>
                `;
            } else {
                content.className = 'result-card lose';
                content.innerHTML = `
                    <div class="result-header"><i class="fas fa-times-circle"></i> Defeat - –ü–æ—Ä–∞–∂–µ–Ω–∏–µ</div>
                    <div class="result-body">–§–ª–æ—Ç —Ä–∞–∑–±–∏—Ç.</div>
                    <div class="result-actions"><button class="btn-restart" onclick="location.reload()">–†–µ–≤–∞–Ω—à</button></div>
                `;
            }
        }

        function determineReward() {
            const rand = Math.random() * 100; 
            if (rand < 15) return `–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ —Ç–∏—Ç—É–ª <b>–ê–¥–º–∏—Ä–∞–ª</b>!<br><img src="https://cdn.jsdelivr.net/gh/xF0RTUNAx/wtm-materials@pics/admiral.jpg" class="reward-img">`;
            else if (rand < 30) return `–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ —Ç–∏—Ç—É–ª <b>–í–æ–ª—á—å—è —Å—Ç–∞—è</b>!<br><img src="https://cdn.jsdelivr.net/gh/xF0RTUNAx/wtm-materials@pics/wolfpack.jpg" class="reward-img">`;
            else if (rand < 45) return `–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ —Ç–∏—Ç—É–ª <b>–ß–µ–º–ø–∏–æ–Ω</b>!<br><img src="https://cdn.jsdelivr.net/gh/xF0RTUNAx/wtm-materials@pics/champ.jpg" class="reward-img">`;
            else if (rand < 99.5) return "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–∞–≥—Ä–∞–¥—ã —É—à–ª–∏ –ø–æ–¥ –≤–æ–¥—É –≤–º–µ—Å—Ç–µ —Å –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–æ–º.";
            else return `–°–£–ü–ï–†–ü–†–ò–ó! (–°–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç)`;
        }

        initGrids();
    </script>
</body>
</html>






